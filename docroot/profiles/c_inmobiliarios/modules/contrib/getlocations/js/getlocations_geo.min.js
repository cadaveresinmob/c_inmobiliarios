(function($){if(typeof(Drupal.getlocations)=='undefined'){Drupal.getlocations={}}Drupal.getlocations.geo={};Drupal.getlocations.geo.EARTH_RADIUS_SEMIMAJOR=6378137.0;Drupal.getlocations.geo.EARTH_FLATTENING=(1/298.257223563);Drupal.getlocations.geo.EARTH_RADIUS_SEMIMINOR=(Drupal.getlocations.geo.EARTH_RADIUS_SEMIMAJOR*(1-Drupal.getlocations.geo.EARTH_FLATTENING));Drupal.getlocations.geo.normalizeLat=function(lat){return Math.max(-90,Math.min(90,lat))};Drupal.getlocations.geo.normalizeLng=function(lng){if(lng%360==180){return 180}lng=lng%360;return lng<-180?lng+360:lng>180?lng-360:lng};Drupal.getlocations.geo.toRad=function(deg){return deg*Math.PI/180};Drupal.getlocations.geo.toDeg=function(rad){return rad*180/Math.PI};Drupal.getlocations.geo.earth_radius=function(latitude){var lat=Drupal.getlocations.geo.toRad(latitude);var x=(Math.cos(lat)/Drupal.getlocations.geo.EARTH_RADIUS_SEMIMAJOR);var y=(Math.sin(lat)/Drupal.getlocations.geo.EARTH_RADIUS_SEMIMINOR);var r=(1/(Math.sqrt(x*x+y*y)));return r};Drupal.getlocations.geo.earth_longitude_range=function(latitude,longitude,distance){if(!distance>0){distance=1}latitude=parseFloat(latitude);longitude=parseFloat(longitude);distance=parseInt(distance);var lng=Drupal.getlocations.geo.toRad(longitude);var lat=Drupal.getlocations.geo.toRad(latitude);var radius=Drupal.getlocations.geo.earth_radius(latitude)*Math.cos(lat);var angle=0;if(radius>0){angle=Math.abs(distance/radius);angle=Math.min(angle,Math.PI)}else{angle=Math.PI}var minlong=lng-angle;var maxlong=lng+angle;if(minlong<-Math.PI){minlong=minlong+Math.PI*2}if(maxlong>Math.PI){maxlong=maxlong-Math.PI*2}var minlongDeg=Drupal.getlocations.geo.toDeg(minlong);minlongDeg=Drupal.getlocations.geo.normalizeLng(minlongDeg);var maxlongDeg=Drupal.getlocations.geo.toDeg(maxlong);maxlongDeg=Drupal.getlocations.geo.normalizeLng(maxlongDeg);var r=[minlongDeg.toFixed(6),maxlongDeg.toFixed(6)];return r};Drupal.getlocations.geo.earth_latitude_range=function(latitude,longitude,distance){if(!distance>0){distance=1}latitude=parseFloat(latitude);longitude=parseFloat(longitude);distance=parseInt(distance);var lng=Drupal.getlocations.geo.toRad(longitude);var lat=Drupal.getlocations.geo.toRad(latitude);var radius=Drupal.getlocations.geo.earth_radius(latitude);var angle=distance/radius;var minlat=lat-angle;var maxlat=lat+angle;var rightangle=Math.PI/2;var overshoot=0;if(minlat<-rightangle){overshoot=-minlat-rightangle;minlat=-rightangle+overshoot;if(minlat>maxlat){maxlat=minlat}minlat=-rightangle}if(maxlat>rightangle){overshoot=maxlat-rightangle;maxlat=rightangle-overshoot;if(maxlat<minlat){minlat=maxlat}maxlat=rightangle}var minlatDeg=Drupal.getlocations.geo.toDeg(minlat);minlatDeg=Drupal.getlocations.geo.normalizeLat(minlatDeg);var maxlatDeg=Drupal.getlocations.geo.toDeg(maxlat);maxlatDeg=Drupal.getlocations.geo.normalizeLat(maxlatDeg);var r=[minlatDeg.toFixed(6),maxlatDeg.toFixed(6)];return r};Drupal.getlocations.geo.earth_distance=function(latitude1,longitude1,latitude2,longitude2){var lat1=Drupal.getlocations.geo.toRad(parseFloat(latitude1));var lng1=Drupal.getlocations.geo.toRad(parseFloat(longitude1));var lat2=Drupal.getlocations.geo.toRad(parseFloat(latitude2));var lng2=Drupal.getlocations.geo.toRad(parseFloat(longitude2));var radius=Drupal.getlocations.geo.earth_radius((parseFloat(latitude1)+parseFloat(latitude2))/2);var cosangle=Math.cos(lat1)*Math.cos(lat2)*(Math.cos(lng1)*Math.cos(lng2)+Math.sin(lng1)*Math.sin(lng2))+Math.sin(lat1)*Math.sin(lat2);return Math.acos(cosangle)*radius};Drupal.getlocations.geo.earth_distance2=function(latitude1,longitude1,latitude2,longitude2){var lat1=Drupal.getlocations.geo.toRad(parseFloat(latitude1));var lng1=Drupal.getlocations.geo.toRad(parseFloat(longitude1));var lat2=Drupal.getlocations.geo.toRad(parseFloat(latitude2));var lng2=Drupal.getlocations.geo.toRad(parseFloat(longitude2));var radius=Drupal.getlocations.geo.earth_radius((parseFloat(latitude1)+parseFloat(latitude2))/2);var latm=lat2-lat1;var lngm=lng2-lng1;var a=Math.sin(latm/2)*Math.sin(latm/ 2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(lngm/2)*Math.sin(lngm/2);return radius*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))};Drupal.getlocations.geo.convert_distance_to_meters=function(distance,distance_unit){if(typeof(distance)!=='number'||!distance>0){return null}var units={'km':1000.0,'m':1.0,'mi':1609.344,'yd':0.9144,'nmi':1852.0};if(units[distance_unit]===undefined){distance_unit='km'}var conv=units[distance_unit];var n=parseFloat(distance)*parseFloat(conv);var retval=n.toFixed(2);return retval};Drupal.getlocations.geo.convert_meters_to_distance=function(meters,distance_unit){if(typeof(meters)!=='number'||!meters>0){return null}var units={'km':0.001,'m':1.0,'mi':0.000621371,'yd':1.093613298,'nmi':0.000539957};if(units[distance_unit]===undefined){distance_unit='km'}var conv=units[distance_unit];var n=parseFloat(meters)*parseFloat(conv);var retval=n.toFixed(2);return retval};Drupal.getlocations.geo.dd_to_dms_do=function(coord,latlon,web){if(typeof web=='undefined')web=true;if(latlon=='lat'){coord=Drupal.getlocations.geo.normalizeLat(coord);direction=(coord<0)?'S':'N'}else{coord=Drupal.getlocations.geo.normalizeLng(coord);direction=(coord<0)?'W':'E'}coord=Math.abs(coord);degrees=Math.floor(coord);coord=(coord-degrees)*60;minutes=Math.floor(coord);coord=(coord-minutes)*60;seconds=Math.round(coord,6);if(web){output=degrees+"&deg;&nbsp;"+minutes+"&#39;&nbsp;"+seconds+"&#34;&nbsp;"+direction}else{output=degrees+'°'+minutes+'′'+seconds+'″'+direction}return output};Drupal.getlocations.geo.dd_to_dms_lat=function(coord){return Drupal.getlocations.geo.dd_to_dms_do(coord,'lat')};Drupal.getlocations.geo.dd_to_dms_lng=function(coord){return Drupal.getlocations.geo.dd_to_dms_do(coord,'lng')};Drupal.getlocations.geo.dd_lat=function(coord,len){if(typeof len=='undefined')len=6;coord=Drupal.getlocations.geo.normalizeLat(coord);return coord.toFixed(len)};Drupal.getlocations.geo.dd_lng=function(coord,len){if(typeof len=='undefined')len=6;coord=Drupal.getlocations.geo.normalizeLng(coord);return coord.toFixed(len)};Drupal.getlocations.geo.parseDMS=function(dmsStr){if(typeof dmsStr=='number'&&isFinite(dmsStr))return Number(dmsStr);var dms=String(dmsStr).trim().replace(/^-/,'').replace(/[NSEW]$/i,'').split(/[^0-9.,]+/);if(dms[dms.length-1]=='')dms.splice(dms.length-1);if(dms=='')return NaN;var deg;switch(dms.length){case 3:deg=dms[0]/1 + dms[1]/60+dms[2]/3600;break;case 2:deg=dms[0]/1 + dms[1]/60;break;case 1:deg=dms[0];break;default:return NaN}if(/^-|[WS]$/i.test(dmsStr.trim()))deg=-deg;return Number(deg)};Drupal.getlocations.geo.toDMS=function(deg,format,dp){if(isNaN(deg))return null;if(typeof format=='undefined')format='dms';if(typeof dp=='undefined'){switch(format){case'd':dp=4;break;case'dm':dp=2;break;case'dms':dp=0;break;default:format='dms';dp=0}}deg=Math.abs(deg);var dms,d,m,s;switch(format){default:case'd':d=deg.toFixed(dp);if(d<100)d='0'+d;if(d<10)d='0'+d;dms=d+'°';break;case'dm':var min=(deg*60).toFixed(dp);d=Math.floor(min/60); m=(min%60).toFixed(dp);if(d<100)d='0'+d;if(d<10)d='0'+d;if(m<10)m='0'+m;dms=d+'°'+m+'′';break;case'dms':var sec=(deg*3600).toFixed(dp);d=Math.floor(sec/3600); m=Math.floor(sec/60)%60;s=(sec%60).toFixed(dp);if(d<100)d='0'+d;if(d<10)d='0'+d;if(m<10)m='0'+m;if(s<10)s='0'+s;dms=d+'°'+m+'′'+s+'″';break}return dms};Drupal.getlocations.geo.toLat=function(deg,format,dp){var lat=Drupal.getlocations.geo.toDMS(deg,format,dp);return lat===null?'–':lat.slice(1)+(deg<0?'S':'N')};Drupal.getlocations.geo.toLon=function(deg,format,dp){var lon=Drupal.getlocations.geo.toDMS(deg,format,dp);return lon===null?'–':lon+(deg<0?'W':'E')};Drupal.getlocations.geo.toBrng=function(deg,format,dp){deg=(Number(deg)+360)%360;var brng=Drupal.getlocations.geo.toDMS(deg,format,dp);return(brng===null?'–':brng.replace('360','0'))}})(jQuery);